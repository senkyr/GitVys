# Refactoring Plan - Git Visualizer v1.5.0

> **C√≠l:** Rozdƒõlit velk√© monolitick√© soubory na men≈°√≠, l√©pe spravovateln√© komponenty podle principu Single Responsibility.

## üìä Motivace

### Probl√©m

Aplikace m√° rychle zaplnƒõn√© kontextov√© okno p≈ôi pr√°ci s AI asistenty (Claude Code) kv≈Øli velk√Ωm soubor≈Øm:

| Soubor | ≈ò√°dky | Velikost | % celku |
|--------|-------|----------|---------|
| `graph_drawer.py` | 1889 | 87.8 KB | 26.5% |
| `main_window.py` | 1225 | 49.1 KB | 17.2% |
| `repository.py` | 1090 | 47.8 KB | 15.3% |
| **CELKEM** | **4204** | **184.7 KB** | **59.1%** |

### ≈òe≈°en√≠: Varianta 1 - Split by Responsibility

Rozdƒõlit t≈ô√≠dy podle odpovƒõdnost√≠ do men≈°√≠ch, soudr≈æn√Ωch komponent:

- **Nejvƒõt≈°√≠ soubor: 1889 ≈ô√°dk≈Ø ‚Üí 8 soubor≈Ø po ~200-400 ≈ô√°dc√≠ch**
- **Postupn√° implementace** bez breaking changes
- **Jasn√© odpovƒõdnosti** ka≈æd√©ho souboru

---

## üéØ F√ÅZE 1: Rozdƒõlen√≠ graph_drawer.py

**Priorita:** VYSOK√Å (nejvƒõt≈°√≠ benefit)
**Odhadovan√Ω ƒças:** 2-3 hodiny
**Velikost:** 1889 ≈ô√°dk≈Ø ‚Üí 8 soubor≈Ø

### Souƒçasn√° struktura

```python
class GraphDrawer:
    # 40 metod, 1889 ≈ô√°dk≈Ø
    # Odpovƒõdnosti:
    # - Vykreslov√°n√≠ spojnic a k≈ôivek
    # - Vykreslov√°n√≠ commit nod≈Ø
    # - Vykreslov√°n√≠ tag≈Ø
    # - Vykreslov√°n√≠ branch flags
    # - Column resizing
    # - Tooltip management
    # - Text formatting
```

### C√≠lov√° struktura

```
src/visualization/
‚îú‚îÄ‚îÄ graph_drawer.py              # Orchestrator (200 ≈ô√°dk≈Ø)
‚îú‚îÄ‚îÄ drawing/                     # Subpackage pro vykreslov√°n√≠
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ connection_drawer.py     # Spojnice a k≈ôivky (300 ≈ô√°dk≈Ø)
‚îÇ   ‚îú‚îÄ‚îÄ commit_drawer.py         # Commit nodes (300 ≈ô√°dk≈Ø)
‚îÇ   ‚îú‚îÄ‚îÄ tag_drawer.py            # Tagy a emoji (200 ≈ô√°dk≈Ø)
‚îÇ   ‚îî‚îÄ‚îÄ branch_flag_drawer.py    # Branch flags (250 ≈ô√°dk≈Ø)
‚îî‚îÄ‚îÄ ui/                          # Subpackage pro UI komponenty
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ column_manager.py        # Column resizing (400 ≈ô√°dk≈Ø)
    ‚îú‚îÄ‚îÄ tooltip_manager.py       # Tooltip syst√©m (100 ≈ô√°dk≈Ø)
    ‚îî‚îÄ‚îÄ text_formatter.py        # Text handling (200 ≈ô√°dk≈Ø)
```

### Detailn√≠ rozdƒõlen√≠

#### 1. `visualization/drawing/connection_drawer.py` (300 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Vykreslov√°n√≠ v≈°ech spojnic mezi commity (ƒç√°ry, k≈ôivky, rozvƒõtven√≠)

**Metody k p≈ôesunu:**

- `_draw_connections()`
- `_draw_line()`
- `_draw_bezier_curve()`
- `_calculate_rounded_corner_arc()`

**Z√°vislosti:**

- `utils.data_structures.Commit`
- `utils.constants` (LINE_WIDTH, NODE_RADIUS)
- `utils.theme_manager` (barvy)

**Interface:**

```python
class ConnectionDrawer:
    def __init__(self, canvas):
        self.canvas = canvas
        self.theme_manager = get_theme_manager()

    def draw_connections(self, commits: List[Commit], branch_lanes: Dict,
                        merge_branches: List[MergeBranch]) -> None:
        """Vykresl√≠ v≈°echny spojnice mezi commity."""
        pass

    def _draw_line(self, x1, y1, x2, y2, color, width) -> int:
        """Vykresl√≠ p≈ô√≠mou ƒç√°ru."""
        pass

    def _draw_bezier_curve(self, points, color, width) -> int:
        """Vykresl√≠ B√©zier k≈ôivku."""
        pass
```

---

#### 2. `visualization/drawing/commit_drawer.py` (300 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Vykreslov√°n√≠ commit nod≈Ø (krou≈æky, text, metadata)

**Metody k p≈ôesunu:**

- `_draw_commits()`
- `_create_circle_polygon()`
- `_draw_branch_flag()` (z√°kladn√≠ vykreslen√≠, bez tooltip logiky)

**Z√°vislosti:**

- `utils.data_structures.Commit`
- `utils.constants` (NODE_RADIUS, FONT_SIZE)
- `utils.theme_manager`
- `utils.translations` (pro p≈ôeklad text≈Ø)

**Interface:**

```python
class CommitDrawer:
    def __init__(self, canvas):
        self.canvas = canvas
        self.theme_manager = get_theme_manager()

    def draw_commits(self, commits: List[Commit], column_widths: Dict,
                     on_tooltip_callback: Callable) -> None:
        """Vykresl√≠ v≈°echny commit nodes s metadaty."""
        pass

    def _create_circle_polygon(self, x: float, y: float, radius: float,
                              num_points: int = 20) -> List[float]:
        """Vytvo≈ô√≠ polygon aproximuj√≠c√≠ kruh."""
        pass
```

---

#### 3. `visualization/drawing/tag_drawer.py` (200 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Vykreslov√°n√≠ Git tag≈Ø s emoji ikonami a tooltips

**Metody k p≈ôesunu:**

- `_draw_tags()`
- `_draw_tag_emoji()`
- `_draw_tag_label()`
- `_add_tag_tooltip()`
- `_calculate_required_tag_space()`

**Z√°vislosti:**

- `utils.data_structures.Tag`
- `utils.constants`
- `utils.theme_manager`

**Interface:**

```python
class TagDrawer:
    def __init__(self, canvas):
        self.canvas = canvas
        self.theme_manager = get_theme_manager()
        self.tag_tooltips = {}

    def draw_tags(self, commits: List[Commit], graph_column_width: int) -> None:
        """Vykresl√≠ v≈°echny tagy u commit≈Ø."""
        pass

    def calculate_required_tag_space(self, commits: List[Commit]) -> int:
        """Vypoƒç√≠t√° pot≈ôebn√Ω prostor pro tagy."""
        pass
```

---

#### 4. `visualization/drawing/branch_flag_drawer.py` (250 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Vykreslov√°n√≠ branch flags (vlajky) a jejich propojen√≠ s commity

**Metody k p≈ôesunu:**

- `_draw_branch_flag()` (pokroƒçil√° verze s tooltips)
- `_add_tooltip_to_flag()`
- `_draw_flag_connection()`
- `_truncate_branch_name()`
- `_calculate_flag_width()`
- `_calculate_horizontal_line_extent()`

**Z√°vislosti:**

- `utils.data_structures.Commit`
- `utils.constants`
- `utils.theme_manager`

**Interface:**

```python
class BranchFlagDrawer:
    def __init__(self, canvas):
        self.canvas = canvas
        self.theme_manager = get_theme_manager()
        self.flag_tooltips = {}

    def draw_branch_flags(self, commits: List[Commit],
                         graph_column_width: int) -> None:
        """Vykresl√≠ branch flags pro v≈°echny commity."""
        pass

    def calculate_flag_width(self, commits: List[Commit]) -> int:
        """Vypoƒç√≠t√° ≈°√≠≈ôku pro branch flags."""
        pass
```

---

#### 5. `visualization/ui/column_manager.py` (400 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Spr√°va sloupc≈Ø - resizing, separ√°tory, drag & drop events

**Metody k p≈ôesunu:**

- `_draw_column_separators()`
- `setup_column_resize_events()`
- `_start_drag()`
- `_on_separator_drag()`
- `_on_separator_release()`
- `_throttled_redraw()`
- `_move_separators_to_scroll_position()`

**Z√°vislosti:**

- tkinter Canvas
- `utils.constants` (MIN_COLUMN_WIDTH_*)
- `utils.theme_manager`

**Interface:**

```python
class ColumnManager:
    def __init__(self, canvas):
        self.canvas = canvas
        self.column_widths = {}
        self.separators = []
        self.dragging = False

    def setup_column_separators(self, column_widths: Dict) -> None:
        """Vytvo≈ô√≠ separ√°tory mezi sloupci."""
        pass

    def setup_resize_events(self, on_resize_callback: Callable) -> None:
        """Nastav√≠ event handlers pro resizing."""
        pass

    def get_column_widths(self) -> Dict:
        """Vr√°t√≠ aktu√°ln√≠ ≈°√≠≈ôky sloupc≈Ø."""
        return self.column_widths
```

---

#### 6. `visualization/ui/tooltip_manager.py` (100 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Spr√°va v≈°ech tooltips (show/hide, pozicov√°n√≠)

**Metody k p≈ôesunu:**

- `_show_tooltip()`
- `_hide_tooltip()`

**Z√°vislosti:**

- tkinter Canvas
- `utils.theme_manager`

**Interface:**

```python
class TooltipManager:
    def __init__(self, canvas):
        self.canvas = canvas
        self.theme_manager = get_theme_manager()
        self.tooltip_id = None
        self.tooltip_text_id = None

    def show_tooltip(self, x: int, y: int, text: str) -> None:
        """Zobraz√≠ tooltip na dan√© pozici."""
        pass

    def hide_tooltip(self) -> None:
        """Skryje aktu√°ln√≠ tooltip."""
        pass
```

---

#### 7. `visualization/ui/text_formatter.py` (200 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Form√°tov√°n√≠ textu - truncation, DPI handling, mƒõ≈ôen√≠ ≈°√≠≈ôky

**Metody k p≈ôesunu:**

- `_truncate_text_to_width()`
- `_truncate_description_for_dpi()`
- `_detect_scaling_factor()`
- `_adjust_descriptions_for_scaling()`
- `_recalculate_descriptions_for_width()`

**Z√°vislosti:**

- tkinter Font
- `utils.constants`

**Interface:**

```python
class TextFormatter:
    def __init__(self, canvas):
        self.canvas = canvas
        self.scaling_factor = self._detect_scaling_factor()

    def truncate_text_to_width(self, text: str, font, max_width: int,
                               suffix: str = "...") -> str:
        """Zkr√°t√≠ text na danou ≈°√≠≈ôku."""
        pass

    def adjust_descriptions_for_dpi(self, commits: List[Commit]) -> None:
        """Uprav√≠ d√©lku popis≈Ø podle DPI."""
        pass

    def detect_scaling_factor(self) -> float:
        """Detekuje DPI scaling factor."""
        pass
```

---

#### 8. `visualization/graph_drawer.py` (200 ≈ô√°dk≈Ø) - ORCHESTRATOR

**Odpovƒõdnost:** Koordinace v≈°ech drawing a UI komponent, ve≈ôejn√© API

**Zachovan√© metody:**

- `__init__()`
- `reset()`
- `draw_graph()` - deleguje na komponenty
- `_calculate_column_widths()` - orchestrace v√Ωpoƒçtu
- `_calculate_graph_column_width()` - deleguje na komponenty
- `_get_table_start_position()`
- `_update_branch_lanes()`
- `_make_color_pale()` - utility

**Nov√° struktura:**

```python
class GraphDrawer:
    """Hlavn√≠ orchestr√°tor pro vykreslov√°n√≠ grafu."""

    def __init__(self):
        self.connection_drawer = None
        self.commit_drawer = None
        self.tag_drawer = None
        self.branch_flag_drawer = None
        self.column_manager = None
        self.tooltip_manager = None
        self.text_formatter = None

    def reset(self):
        """Reset stavu v≈°ech komponent."""
        if self.tooltip_manager:
            self.tooltip_manager.hide_tooltip()
        # ...

    def draw_graph(self, canvas, commits, merge_branches, ...):
        """
        Hlavn√≠ entry point - orchestruje cel√© vykreslen√≠ grafu.

        Deleguje na jednotliv√© komponenty v tomto po≈ôad√≠:
        1. ConnectionDrawer - spojnice
        2. CommitDrawer - commit nodes
        3. TagDrawer - tagy
        4. BranchFlagDrawer - branch flags
        5. ColumnManager - separ√°tory
        """
        # Initialize components if needed
        if not self.connection_drawer:
            self._initialize_components(canvas)

        # Calculate layout
        column_widths = self._calculate_column_widths(canvas, commits, ...)

        # Delegate drawing to components
        self.connection_drawer.draw_connections(commits, ...)
        self.commit_drawer.draw_commits(commits, column_widths, ...)
        self.tag_drawer.draw_tags(commits, ...)
        self.branch_flag_drawer.draw_branch_flags(commits, ...)
        self.column_manager.setup_column_separators(column_widths)

    def _initialize_components(self, canvas):
        """Inicializuje v≈°echny drawing a UI komponenty."""
        self.connection_drawer = ConnectionDrawer(canvas)
        self.commit_drawer = CommitDrawer(canvas)
        self.tag_drawer = TagDrawer(canvas)
        self.branch_flag_drawer = BranchFlagDrawer(canvas)
        self.column_manager = ColumnManager(canvas)
        self.tooltip_manager = TooltipManager(canvas)
        self.text_formatter = TextFormatter(canvas)
```

---

### Implementaƒçn√≠ checklist - F√°ze 1

- [x] **Krok 1: P≈ô√≠prava**
  - [x] Vytvo≈ôit `src/visualization/drawing/__init__.py`
  - [x] Vytvo≈ôit `src/visualization/ui/__init__.py`
  - [x] Commit: "Prepare directory structure for graph_drawer refactoring"

- [x] **Krok 2: ConnectionDrawer**
  - [x] Vytvo≈ôit `src/visualization/drawing/connection_drawer.py`
  - [x] P≈ôesunout metody: `_draw_connections`, `_draw_line`, `_draw_bezier_curve`, `_calculate_rounded_corner_arc`
  - [x] Aktualizovat imports v `graph_drawer.py`
  - [x] Otestovat vykreslov√°n√≠ spojnic
  - [x] Commit: "Extract ConnectionDrawer from GraphDrawer"

- [x] **Krok 3: CommitDrawer**
  - [x] Vytvo≈ôit `src/visualization/drawing/commit_drawer.py`
  - [x] P≈ôesunout metody: `_draw_commits`, `_create_circle_polygon`
  - [x] Aktualizovat `graph_drawer.py` pro pou≈æit√≠ CommitDrawer
  - [x] Otestovat vykreslov√°n√≠ commit≈Ø
  - [x] Commit: "Extract CommitDrawer from GraphDrawer"

- [x] **Krok 4: TagDrawer**
  - [x] Vytvo≈ôit `src/visualization/drawing/tag_drawer.py`
  - [x] P≈ôesunout metody pro tagy
  - [x] Aktualizovat `graph_drawer.py`
  - [x] Otestovat vykreslov√°n√≠ tag≈Ø
  - [x] Commit: "Extract TagDrawer from GraphDrawer"

- [x] **Krok 5: BranchFlagDrawer**
  - [x] Vytvo≈ôit `src/visualization/drawing/branch_flag_drawer.py`
  - [x] P≈ôesunout metody pro branch flags
  - [x] Aktualizovat `graph_drawer.py`
  - [x] Otestovat branch flags
  - [x] Commit: "Extract BranchFlagDrawer from GraphDrawer"

- [x] **Krok 6: TooltipManager**
  - [x] Vytvo≈ôit `src/visualization/ui/tooltip_manager.py`
  - [x] P≈ôesunout `_show_tooltip`, `_hide_tooltip`
  - [x] Aktualizovat v≈°echny komponenty pro pou≈æit√≠ TooltipManager
  - [x] Otestovat tooltips
  - [x] Commit: "Extract TooltipManager from GraphDrawer"

- [x] **Krok 7: TextFormatter**
  - [x] Vytvo≈ôit `src/visualization/ui/text_formatter.py`
  - [x] P≈ôesunout v≈°echny text handling metody
  - [x] Aktualizovat komponenty
  - [x] Otestovat text truncation
  - [x] Commit: "Extract TextFormatter from GraphDrawer"

- [x] **Krok 8: ColumnManager**
  - [x] Vytvo≈ôit `src/visualization/ui/column_manager.py`
  - [x] P≈ôesunout v≈°echny column resizing metody
  - [x] Aktualizovat `graph_drawer.py`
  - [x] Otestovat column resizing
  - [x] Commit: "Extract ColumnManager from GraphDrawer"

- [x] **Krok 9: Finalizace**
  - [x] Aktualizovat `graph_drawer.py` jako orchestr√°tor
  - [x] Zkontrolovat v≈°echny importy
  - [x] Spustit aplikaci a otestovat v≈°echny features
  - [x] Commit: "Finalize GraphDrawer refactoring - now orchestrator only"

- [x] **Krok 10: Dokumentace** ‚úÖ HOTOVO
  - [x] Aktualizovat `docs/DESIGN.md` s novou strukturou ‚úÖ
  - [x] Aktualizovat `README.md` strukturu ‚úÖ
  - [x] Aktualizovat `CLAUDE.md` strukturu ‚úÖ
  - [ ] Commit: "Update documentation for GraphDrawer refactoring" (zat√≠m bez commit≈Ø)

---

## üéØ F√ÅZE 2: Rozdƒõlen√≠ repository.py

**Priorita:** ST≈òEDN√ç
**Odhadovan√Ω ƒças:** 1-2 hodiny
**Velikost:** 1090 ≈ô√°dk≈Ø ‚Üí 5 soubor≈Ø

### C√≠lov√° struktura

```
src/repo/
‚îú‚îÄ‚îÄ repository.py                # Facade (200 ≈ô√°dk≈Ø)
‚îú‚îÄ‚îÄ parsers/                     # Subpackage pro parsing
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ commit_parser.py         # Commit parsing (300 ≈ô√°dk≈Ø)
‚îÇ   ‚îú‚îÄ‚îÄ branch_analyzer.py       # Branch detection (300 ≈ô√°dk≈Ø)
‚îÇ   ‚îî‚îÄ‚îÄ tag_parser.py            # Tag parsing (150 ≈ô√°dk≈Ø)
‚îî‚îÄ‚îÄ analyzers/                   # Subpackage pro anal√Ωzu
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îî‚îÄ‚îÄ merge_detector.py        # Merge branch detection (350 ≈ô√°dk≈Ø)
```

### Detailn√≠ rozdƒõlen√≠

#### 1. `repo/parsers/commit_parser.py` (300 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Parsing commit≈Ø z Git repozit√°≈ôe

**Metody k p≈ôesunu:**

- `parse_commits()`
- `parse_commits_with_remote()`
- `_truncate_message()`
- `_truncate_name()`
- `_truncate_description()`
- `_get_relative_date()`
- `_get_short_date()`
- `_get_full_date()`

**Interface:**

```python
class CommitParser:
    def __init__(self, repo: Repo):
        self.repo = repo

    def parse_commits(self, include_remote: bool = False) -> List[Commit]:
        """Parsuje commity z repozit√°≈ôe."""
        pass

    def _truncate_message(self, message: str, max_length: int) -> str:
        """Zkr√°t√≠ commit message."""
        pass
```

---

#### 2. `repo/parsers/branch_analyzer.py` (300 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Anal√Ωza vƒõtv√≠ a jejich vztah≈Ø

**Metody k p≈ôesunu:**

- `_build_commit_branch_map()`
- `_build_commit_branch_map_with_remote()`
- `_build_branch_availability_map()`
- `_detect_branch_divergence()`

**Interface:**

```python
class BranchAnalyzer:
    def __init__(self, repo: Repo):
        self.repo = repo

    def build_commit_branch_map(self, include_remote: bool = False) -> Dict[str, str]:
        """Vytvo≈ô√≠ mapu commit ‚Üí branch."""
        pass

    def detect_branch_divergence(self, branch_name: str) -> Dict:
        """Detekuje divergenci vƒõtve."""
        pass
```

---

#### 3. `repo/parsers/tag_parser.py` (150 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Parsing Git tag≈Ø

**Metody k p≈ôesunu:**

- `_build_commit_tag_map()`
- `_build_commit_tag_map_with_remote()`

**Interface:**

```python
class TagParser:
    def __init__(self, repo: Repo):
        self.repo = repo

    def build_commit_tag_map(self, include_remote: bool = False) -> Dict[str, List[Tag]]:
        """Vytvo≈ô√≠ mapu commit ‚Üí tagy."""
        pass
```

---

#### 4. `repo/analyzers/merge_detector.py` (350 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Detekce a anal√Ωza merge vƒõtv√≠

**Metody k p≈ôesunu:**

- `_detect_merge_branches()`
- `_apply_merge_branch_styling()`
- `_build_full_hash_map()`
- `_trace_merge_branch_commits()`
- `_get_commits_in_branches_with_head()`
- `_extract_branch_name_from_merge()`
- `_make_color_pale()`

**Interface:**

```python
class MergeDetector:
    def __init__(self, commits: List[Commit]):
        self.commits = commits

    def detect_merge_branches(self) -> List[MergeBranch]:
        """Detekuje merge vƒõtve."""
        pass

    def apply_merge_branch_styling(self, merge_branches: List[MergeBranch]) -> None:
        """Aplikuje styling na merge vƒõtve."""
        pass
```

---

#### 5. `repo/repository.py` (200 ≈ô√°dk≈Ø) - FACADE

**Odpovƒõdnost:** Ve≈ôejn√© API pro pr√°ci s repozit√°≈ôem

**Zachovan√© metody:**

- `__init__()`
- `load_repository()` - deleguje na parsery
- `get_uncommitted_changes()`
- `_create_uncommitted_commits()`
- `get_merge_branches()` - deleguje na MergeDetector
- `get_repository_stats()`

**Nov√° struktura:**

```python
class GitRepository:
    """Facade pro pr√°ci s Git repozit√°≈ôem."""

    def __init__(self, repo_path: str):
        self.repo_path = repo_path
        self.repo = None
        self.commit_parser = None
        self.branch_analyzer = None
        self.tag_parser = None
        self.merge_detector = None

    def load_repository(self) -> bool:
        """Naƒçte repozit√°≈ô a inicializuje parsery."""
        try:
            self.repo = Repo(self.repo_path)
            self.commit_parser = CommitParser(self.repo)
            self.branch_analyzer = BranchAnalyzer(self.repo)
            self.tag_parser = TagParser(self.repo)
            return True
        except Exception as e:
            logger.error(f"Failed to load repository: {e}")
            return False

    def parse_commits(self, include_remote: bool = False) -> List[Commit]:
        """Deleguje na CommitParser."""
        commits = self.commit_parser.parse_commits(include_remote)

        # Detect merge branches
        self.merge_detector = MergeDetector(commits)
        merge_branches = self.merge_detector.detect_merge_branches()
        self.merge_detector.apply_merge_branch_styling(merge_branches)

        return commits
```

---

### Implementaƒçn√≠ checklist - F√°ze 2

- [x] **Krok 1: P≈ô√≠prava**
  - [x] Vytvo≈ôit `src/repo/parsers/__init__.py`
  - [x] Vytvo≈ôit `src/repo/analyzers/__init__.py`
  - [x] Commit: "Prepare directory structure for repository refactoring"

- [x] **Krok 2: CommitParser**
  - [x] Vytvo≈ôit `src/repo/parsers/commit_parser.py`
  - [x] P≈ôesunout parsing metody
  - [x] Aktualizovat `repository.py`
  - [x] Otestovat parsing commit≈Ø
  - [x] Commit: "Extract CommitParser from GitRepository"

- [x] **Krok 3: BranchAnalyzer**
  - [x] Vytvo≈ôit `src/repo/parsers/branch_analyzer.py`
  - [x] P≈ôesunout branch analysis metody
  - [x] Aktualizovat `repository.py`
  - [x] Otestovat branch detection
  - [x] Commit: "Extract BranchAnalyzer from GitRepository"

- [x] **Krok 4: TagParser**
  - [x] Vytvo≈ôit `src/repo/parsers/tag_parser.py`
  - [x] P≈ôesunout tag parsing metody
  - [x] Aktualizovat `repository.py`
  - [x] Otestovat tag parsing
  - [x] Commit: "Extract TagParser from GitRepository"

- [x] **Krok 5: MergeDetector**
  - [x] Vytvo≈ôit `src/repo/analyzers/merge_detector.py`
  - [x] P≈ôesunout merge detection metody
  - [x] Aktualizovat `repository.py`
  - [x] Otestovat merge detection
  - [x] Commit: "Extract MergeDetector from GitRepository"

- [x] **Krok 6: Finalizace**
  - [x] Aktualizovat `repository.py` jako facade
  - [x] Zkontrolovat v≈°echny importy
  - [x] Spustit aplikaci a otestovat loading repozit√°≈ô≈Ø
  - [x] Commit: "Finalize GitRepository refactoring - now facade only"

- [ ] **Krok 7: Dokumentace**
  - [ ] Aktualizovat dokumentaci
  - [ ] Commit: "Update documentation for GitRepository refactoring"

---

## üéØ F√ÅZE 3: Rozdƒõlen√≠ main_window.py

**Priorita:** N√çZK√Å
**Odhadovan√Ω ƒças:** 1-2 hodiny
**Velikost:** 1225 ≈ô√°dk≈Ø ‚Üí 5 soubor≈Ø

### C√≠lov√° struktura

```
src/gui/
‚îú‚îÄ‚îÄ main_window.py               # Layout manager (400 ≈ô√°dk≈Ø)
‚îú‚îÄ‚îÄ repo_manager.py              # Repository operations (500 ≈ô√°dk≈Ø)
‚îî‚îÄ‚îÄ ui_components/               # Subpackage pro UI komponenty
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ language_switcher.py     # Language switching (100 ≈ô√°dk≈Ø)
    ‚îú‚îÄ‚îÄ theme_switcher.py        # Theme switching (100 ≈ô√°dk≈Ø)
    ‚îî‚îÄ‚îÄ stats_display.py         # Stats display (100 ≈ô√°dk≈Ø)
```

### Detailn√≠ rozdƒõlen√≠

#### 1. `gui/repo_manager.py` (500 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Spr√°va repozit√°≈ô≈Ø - loading, cloning, cleanup

**Metody k p≈ôesunu:**

- `on_repository_selected()`
- `_is_git_url()`
- `clone_repository()`
- `_clone_worker()`
- `_show_auth_dialog_sync()`
- `_on_clone_complete()`
- `_cleanup_old_temp_clones()`
- `_cleanup_single_clone()`
- `_cleanup_temp_clones()`
- `load_repository()`
- `refresh_repository()`
- `refresh_local_repository()`
- `fetch_remote_data()`

**Interface:**

```python
class RepositoryManager:
    def __init__(self, parent_window):
        self.parent = parent_window
        self.current_repo = None
        self.temp_clone_path = None

    def load_repository(self, repo_path: str) -> None:
        """Naƒçte lok√°ln√≠ repozit√°≈ô."""
        pass

    def clone_repository(self, url: str) -> None:
        """Naklonuje remote repozit√°≈ô."""
        pass

    def refresh_repository(self) -> None:
        """Obnov√≠ aktu√°ln√≠ repozit√°≈ô."""
        pass
```

---

#### 2. `gui/ui_components/language_switcher.py` (100 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** P≈ôep√≠n√°n√≠ jazyk≈Ø

**Metody k p≈ôesunu:**

- `_create_czech_flag()`
- `_create_uk_flag()`
- `_switch_to_language()`
- `_update_flag_appearance()`
- `_on_language_changed()`

**Interface:**

```python
class LanguageSwitcher:
    def __init__(self, parent_frame):
        self.parent = parent_frame
        self.translation_manager = get_translation_manager()
        self.czech_canvas = None
        self.uk_canvas = None

    def create_switcher_ui(self) -> tk.Frame:
        """Vytvo≈ô√≠ UI pro p≈ôep√≠n√°n√≠ jazyk≈Ø."""
        pass

    def switch_to_language(self, language: str) -> None:
        """P≈ôepne na dan√Ω jazyk."""
        pass
```

---

#### 3. `gui/ui_components/theme_switcher.py` (100 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** P≈ôep√≠n√°n√≠ t√©mat

**Metody k p≈ôesunu:**

- `_create_sun_icon()`
- `_create_moon_icon()`
- `_switch_to_theme()`
- `_update_theme_icon_appearance()`
- `_on_theme_changed()`

**Interface:**

```python
class ThemeSwitcher:
    def __init__(self, parent_frame):
        self.parent = parent_frame
        self.theme_manager = get_theme_manager()
        self.sun_canvas = None
        self.moon_canvas = None

    def create_switcher_ui(self) -> tk.Frame:
        """Vytvo≈ô√≠ UI pro p≈ôep√≠n√°n√≠ t√©mat."""
        pass

    def switch_to_theme(self, theme: str) -> None:
        """P≈ôepne na dan√© t√©ma."""
        pass
```

---

#### 4. `gui/ui_components/stats_display.py` (100 ≈ô√°dk≈Ø)

**Odpovƒõdnost:** Zobrazen√≠ statistik repozit√°≈ôe

**Metody k p≈ôesunu:**

- `_update_stats_display()`
- `_show_repo_path_tooltip()`
- `_hide_repo_path_tooltip()`

**Interface:**

```python
class StatsDisplay:
    def __init__(self, parent_frame):
        self.parent = parent_frame
        self.stats_label = None
        self.tooltip_window = None

    def create_stats_ui(self) -> tk.Label:
        """Vytvo≈ô√≠ UI pro statistiky."""
        pass

    def update_stats(self, repo_path: str, commits: List[Commit], ...) -> None:
        """Aktualizuje zobrazen√≠ statistik."""
        pass
```

---

#### 5. `gui/main_window.py` (400 ≈ô√°dk≈Ø) - LAYOUT MANAGER

**Odpovƒõdnost:** UI layout, koordinace komponent

**Zachovan√© metody:**

- `__init__()`
- `_center_window()`
- `_resize_window_for_content()`
- `_get_accurate_content_width()`
- `_calculate_table_width()`
- `setup_ui()` - pou≈æije komponenty

**Nov√° struktura:**

```python
class MainWindow:
    """Hlavn√≠ okno aplikace - layout manager."""

    def __init__(self):
        self.root = tk.Tk()
        self.repo_manager = RepositoryManager(self)
        self.language_switcher = None
        self.theme_switcher = None
        self.stats_display = None
        # ...

    def setup_ui(self):
        """Nastav√≠ UI pomoc√≠ komponent."""
        # Create top bar with switchers
        top_bar = ttk.Frame(self.root)

        self.language_switcher = LanguageSwitcher(top_bar)
        lang_frame = self.language_switcher.create_switcher_ui()

        self.theme_switcher = ThemeSwitcher(top_bar)
        theme_frame = self.theme_switcher.create_switcher_ui()

        # Create stats display
        self.stats_display = StatsDisplay(top_bar)
        stats_label = self.stats_display.create_stats_ui()

        # Create drag & drop area
        self.drag_drop_frame = DragDropFrame(
            self.root,
            on_select=self.repo_manager.on_repository_selected
        )

        # ...
```

---

### Implementaƒçn√≠ checklist - F√°ze 3

- [ ] **Krok 1: P≈ô√≠prava**
  - [ ] Vytvo≈ôit `src/gui/ui_components/__init__.py`
  - [ ] Commit: "Prepare directory structure for main_window refactoring"

- [ ] **Krok 2: LanguageSwitcher**
  - [ ] Vytvo≈ôit `src/gui/ui_components/language_switcher.py`
  - [ ] P≈ôesunout metody
  - [ ] Aktualizovat `main_window.py`
  - [ ] Otestovat p≈ôep√≠n√°n√≠ jazyka
  - [ ] Commit: "Extract LanguageSwitcher from MainWindow"

- [ ] **Krok 3: ThemeSwitcher**
  - [ ] Vytvo≈ôit `src/gui/ui_components/theme_switcher.py`
  - [ ] P≈ôesunout metody
  - [ ] Aktualizovat `main_window.py`
  - [ ] Otestovat p≈ôep√≠n√°n√≠ t√©matu
  - [ ] Commit: "Extract ThemeSwitcher from MainWindow"

- [ ] **Krok 4: StatsDisplay**
  - [ ] Vytvo≈ôit `src/gui/ui_components/stats_display.py`
  - [ ] P≈ôesunout metody
  - [ ] Aktualizovat `main_window.py`
  - [ ] Otestovat zobrazen√≠ statistik
  - [ ] Commit: "Extract StatsDisplay from MainWindow"

- [ ] **Krok 5: RepositoryManager**
  - [ ] Vytvo≈ôit `src/gui/repo_manager.py`
  - [ ] P≈ôesunout v≈°echny repo operations
  - [ ] Aktualizovat `main_window.py`
  - [ ] Otestovat loading a cloning
  - [ ] Commit: "Extract RepositoryManager from MainWindow"

- [ ] **Krok 6: Finalizace**
  - [ ] Aktualizovat `main_window.py` jako layout manager
  - [ ] Zkontrolovat v≈°echny importy
  - [ ] Spustit aplikaci a otestovat v≈°echny features
  - [ ] Commit: "Finalize MainWindow refactoring - now layout manager only"

- [ ] **Krok 7: Dokumentace**
  - [ ] Aktualizovat dokumentaci
  - [ ] Commit: "Update documentation for MainWindow refactoring"

---

## üìà Oƒçek√°van√© benefity

### P≈ôed refaktoringem

```
graph_drawer.py   : 1889 ≈ô√°dk≈Ø (87.8 KB)
repository.py     : 1090 ≈ô√°dk≈Ø (47.8 KB)
main_window.py    : 1225 ≈ô√°dk≈Ø (49.1 KB)
--------------------------------
CELKEM            : 4204 ≈ô√°dk≈Ø (184.7 KB) - 59% k√≥dov√© b√°ze
```

### Po refaktoringu

```
visualization/
‚îú‚îÄ‚îÄ graph_drawer.py           :  200 ≈ô√°dk≈Ø
‚îú‚îÄ‚îÄ drawing/
‚îÇ   ‚îú‚îÄ‚îÄ connection_drawer.py  :  300 ≈ô√°dk≈Ø
‚îÇ   ‚îú‚îÄ‚îÄ commit_drawer.py      :  300 ≈ô√°dk≈Ø
‚îÇ   ‚îú‚îÄ‚îÄ tag_drawer.py         :  200 ≈ô√°dk≈Ø
‚îÇ   ‚îî‚îÄ‚îÄ branch_flag_drawer.py :  250 ≈ô√°dk≈Ø
‚îî‚îÄ‚îÄ ui/
    ‚îú‚îÄ‚îÄ column_manager.py     :  400 ≈ô√°dk≈Ø
    ‚îú‚îÄ‚îÄ tooltip_manager.py    :  100 ≈ô√°dk≈Ø
    ‚îî‚îÄ‚îÄ text_formatter.py     :  200 ≈ô√°dk≈Ø

repo/
‚îú‚îÄ‚îÄ repository.py             :  200 ≈ô√°dk≈Ø
‚îú‚îÄ‚îÄ parsers/
‚îÇ   ‚îú‚îÄ‚îÄ commit_parser.py      :  300 ≈ô√°dk≈Ø
‚îÇ   ‚îú‚îÄ‚îÄ branch_analyzer.py    :  300 ≈ô√°dk≈Ø
‚îÇ   ‚îî‚îÄ‚îÄ tag_parser.py         :  150 ≈ô√°dk≈Ø
‚îî‚îÄ‚îÄ analyzers/
    ‚îî‚îÄ‚îÄ merge_detector.py     :  350 ≈ô√°dk≈Ø

gui/
‚îú‚îÄ‚îÄ main_window.py            :  400 ≈ô√°dk≈Ø
‚îú‚îÄ‚îÄ repo_manager.py           :  500 ≈ô√°dk≈Ø
‚îî‚îÄ‚îÄ ui_components/
    ‚îú‚îÄ‚îÄ language_switcher.py  :  100 ≈ô√°dk≈Ø
    ‚îú‚îÄ‚îÄ theme_switcher.py     :  100 ≈ô√°dk≈Ø
    ‚îî‚îÄ‚îÄ stats_display.py      :  100 ≈ô√°dk≈Ø

--------------------------------
CELKEM                        : ~4200 ≈ô√°dk≈Ø v 18 souborech
NEJVƒöT≈†√ç SOUBOR               :  500 ≈ô√°dk≈Ø (vs. 1889 d≈ô√≠ve)
```

### Metriky

| Metrika | P≈ôed | Po | Zlep≈°en√≠ |
|---------|------|----|----|
| **Nejvƒõt≈°√≠ soubor** | 1889 ≈ô√°dk≈Ø | 500 ≈ô√°dk≈Ø | **-73%** |
| **Pr≈Ømƒõrn√° velikost** | 1400 ≈ô√°dk≈Ø | 233 ≈ô√°dk≈Ø | **-83%** |
| **Kontextov√© okno** | 184 KB najednou | ~20-50 KB | **-70-80%** |
| **Poƒçet odpovƒõdnost√≠/soubor** | 5-8 | 1-2 | **-75%** |

### Konkr√©tn√≠ p≈ô√≠nosy

1. **Rychlej≈°√≠ pr√°ce s AI**
   - Claude Code naƒçte jen relevantn√≠ soubory (200-500 ≈ô√°dk≈Ø m√≠sto 1889)
   - 70-80% redukce kontextov√©ho okna p≈ôi pr√°ci na konkr√©tn√≠ feature

2. **Lep≈°√≠ ƒçitelnost**
   - Ka≈æd√Ω soubor m√° jasnou, jednoduchou odpovƒõdnost
   - Snadnƒõj≈°√≠ orientace v k√≥du
   - M√©nƒõ scrollov√°n√≠

3. **Jednodu≈°≈°√≠ testov√°n√≠**
   - Ka≈æd√° komponenta testovateln√° izolovanƒõ
   - Snadnƒõj≈°√≠ mockov√°n√≠ z√°vislost√≠
   - Rychlej≈°√≠ unit testy

4. **Lep≈°√≠ maintainability**
   - Zmƒõny v jedn√© oblasti neovlivn√≠ ostatn√≠
   - Jasn√© rozhran√≠ mezi komponentami
   - Snadnƒõj≈°√≠ refaktoring jednotliv√Ωch ƒç√°st√≠

5. **Paraleln√≠ v√Ωvoj**
   - V√≠ce lid√≠ m≈Ø≈æe pracovat na r≈Øzn√Ωch komponent√°ch bez konflikt≈Ø

---

## ‚ö†Ô∏è Rizika a mitigace

### Riziko 1: Breaking changes

**Mitigace:** Zachovat p≈Øvodn√≠ ve≈ôejn√© API, zmƒõnit jen intern√≠ implementaci

### Riziko 2: Chyby p≈ôi p≈ôesunu k√≥du

**Mitigace:**

- Postupn√° implementace s testy po ka≈æd√©m kroku
- Commit po ka≈æd√© extrahovan√© komponentƒõ
- Mo≈ænost rychl√©ho rollbacku

### Riziko 3: Zv√Ω≈°en√° slo≈æitost import≈Ø

**Mitigace:**

- Pou≈æ√≠t `__init__.py` pro re-export bƒõ≈ænƒõ pou≈æ√≠van√Ωch t≈ô√≠d
- Zachovat jednoduch√© importy pro koncov√© u≈æivatele

### Riziko 4: Zv√Ω≈°en√≠ build ƒçasu

**Mitigace:**

- PyInstaller by nemƒõl b√Ωt ovlivnƒõn (stejn√Ω poƒçet modul≈Ø)
- Mo≈æn√© m√≠rn√© zpomalen√≠ (< 5%)

---

## üß™ Testovac√≠ strategie

### P≈ôed zaƒç√°tkem refaktoringu

- [ ] Spustit aplikaci a otestovat v≈°echny z√°kladn√≠ features
- [ ] Otestovat loading lok√°ln√≠ho repozit√°≈ôe
- [ ] Otestovat cloning remote repozit√°≈ôe
- [ ] Otestovat p≈ôep√≠n√°n√≠ jazyka
- [ ] Otestovat p≈ôep√≠n√°n√≠ t√©matu
- [ ] Otestovat column resizing
- [ ] Otestovat tooltips
- [ ] Otestovat zobrazen√≠ tag≈Ø
- [ ] Vytvo≈ôit screenshot reference

### Po ka≈æd√© f√°zi refaktoringu

- [ ] Spustit aplikaci
- [ ] Otestovat v≈°echny features z minul√© sekce
- [ ] Porovnat s reference screenshoty
- [ ] Zkontrolovat console na warnings/errors
- [ ] Zkontrolovat log soubor

### Po dokonƒçen√≠ v≈°ech f√°z√≠

- [ ] Kompletn√≠ manu√°ln√≠ testing v≈°ech features
- [ ] Performance test (load velk√©ho repozit√°≈ôe)
- [ ] Memory leak test (load/unload repozit√°≈ôe opakovanƒõ)
- [ ] Build .exe a otestovat
- [ ] Otestovat na ƒçist√©m syst√©mu

---

## üìù Pozn√°mky k implementaci

### Import conventions

```python
# Doporuƒçen√© importy po refaktoringu:

# Nam√≠sto:
from visualization.graph_drawer import GraphDrawer

# Pou≈æ√≠t:
from visualization import GraphDrawer  # re-export v __init__.py

# Pro intern√≠ komponenty:
from visualization.drawing.connection_drawer import ConnectionDrawer
```

### **init**.py soubory

```python
# visualization/__init__.py
from .graph_drawer import GraphDrawer
from .layout import GraphLayout
from .colors import get_branch_color

__all__ = ['GraphDrawer', 'GraphLayout', 'get_branch_color']

# visualization/drawing/__init__.py
from .connection_drawer import ConnectionDrawer
from .commit_drawer import CommitDrawer
from .tag_drawer import TagDrawer
from .branch_flag_drawer import BranchFlagDrawer

__all__ = [
    'ConnectionDrawer',
    'CommitDrawer',
    'TagDrawer',
    'BranchFlagDrawer'
]
```

### Zpƒõtn√° kompatibilita

```python
# Pro zachov√°n√≠ zpƒõtn√© kompatibility (pokud by nƒõkdo importoval intern√≠ metody):

# graph_drawer.py (legacy support)
from visualization.drawing.connection_drawer import ConnectionDrawer

class GraphDrawer:
    # ... nov√° implementace ...

    # Legacy methods (deprecated)
    def _draw_connections(self, *args, **kwargs):
        """DEPRECATED: Use self.connection_drawer.draw_connections()"""
        warnings.warn("_draw_connections is deprecated", DeprecationWarning)
        return self.connection_drawer.draw_connections(*args, **kwargs)
```

---

## üéØ Success Criteria

Refaktoring je √∫spƒõ≈°n√Ω, pokud:

- [ ] ‚úÖ V≈°echny soubory jsou men≈°√≠ ne≈æ 500 ≈ô√°dk≈Ø
- [ ] ‚úÖ Ka≈æd√Ω soubor m√° max. 2 hlavn√≠ odpovƒõdnosti
- [ ] ‚úÖ Aplikace funguje identicky jako p≈ôed refaktoringem
- [ ] ‚úÖ V≈°echny tests proch√°zej√≠ (pokud existuj√≠)
- [ ] ‚úÖ .exe build funguje bez probl√©m≈Ø
- [ ] ‚úÖ Dokumentace je aktualizov√°na
- [ ] ‚úÖ Kontextov√© okno p≈ôi pr√°ci s AI je o 70%+ men≈°√≠

---

## üìö Reference

- **Principy:**
  - [Single Responsibility Principle](https://en.wikipedia.org/wiki/Single-responsibility_principle)
  - [Separation of Concerns](https://en.wikipedia.org/wiki/Separation_of_concerns)
  - [Facade Pattern](https://refactoring.guru/design-patterns/facade)
  - [Composition over Inheritance](https://en.wikipedia.org/wiki/Composition_over_inheritance)

- **Souvisej√≠c√≠ dokumenty:**
  - `docs/DESIGN.md` - Aktu√°ln√≠ architektura
  - `CLAUDE.md` - Development guide
  - `docs/CHANGELOG.md` - Historie zmƒõn

---

**Autor:** Claude Code + User
**Datum vytvo≈ôen√≠:** 2025-01-12
**Verze:** 1.0
**Status:** üìã Ready for Implementation
